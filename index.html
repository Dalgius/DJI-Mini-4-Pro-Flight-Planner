<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJI Mini 4 Pro Flight Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Overlay di Caricamento -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">Calcolo...</div>

    <!-- Modale di Alert Personalizzata -->
    <div id="customAlertOverlay" class="modal-overlay" style="display:none;">
        <div class="modal-content custom-alert-content">
            <h3 id="customAlertTitle" style="margin-bottom: 15px; color: #e0e0e0;">Notifica</h3>
            <p id="customAlertMessage" style="color:white; margin-bottom:20px; font-size: 14px;"></p>
            <button id="customAlertOkButton" class="btn" style="min-width: 80px;">OK</button>
        </div>
    </div>

    <!-- Modale per Creazione Orbita POI -->
    <div id="orbitModalOverlay" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2 style="color: #3498db; margin-bottom: 20px;">Create POI Orbit</h2>
            <div class="control-group">
                <label for="orbitPoiSelect" class="control-label">Center POI:</label>
                <select id="orbitPoiSelect" class="control-input"></select>
            </div>
            <div class="control-group">
                <label for="orbitRadiusInput" class="control-label">Radius (m):</label>
                <input type="number" id="orbitRadiusInput" class="control-input" value="30" min="5" step="1">
            </div>
            <div class="control-group">
                <label for="orbitPointsInput" class="control-label">Number of Waypoints:</label>
                <input type="number" id="orbitPointsInput" class="control-input" value="8" min="3" step="1">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancelOrbitBtn" class="btn btn-secondary" style="width: auto;">Cancel</button>
                <button id="confirmOrbitBtn" class="btn" style="width: auto;">Create Orbit</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="app-header">
                <div class="app-title">‚úàÔ∏è DJI Mini 4 Pro</div>
                <div class="app-subtitle">Flight Planner</div>
            </div>

            <div class="section">
                <div class="section-title">üõ©Ô∏è Flight Settings</div>
                <div class="control-group">
                    <label class="control-label">Default Altitude (m) <span style="font-style: italic; color: #95a5a6;">(Rel. to Takeoff)</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="defaultAltitude" min="5" max="120" value="50"> <span class="slider-value" id="defaultAltitudeValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Flight Speed (m/s)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="flightSpeed" min="1" max="17" value="2.5"> <span class="slider-value" id="flightSpeedValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Path Type (Turn Mode)</label>
                    <select class="control-input" id="pathType">
                        <option value="straight">Straight (ToPointAndStopWithContinuity)</option>
                        <option value="curved">Curved (ToPointAndPassWithContinuity)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìç Waypoints</div>
                 <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="selectAllWaypointsCheckbox" style="transform: scale(1.2);">
                    <label for="selectAllWaypointsCheckbox" style="font-size: 12px; cursor:pointer;">Select/Deselect All</label>
                </div>
                <button class="btn btn-danger" id="clearWaypointsBtn">Clear All Waypoints</button>
                <div class="waypoint-list" id="waypointList"></div>
            </div>
            
            <div class="section" id="multiWaypointEditControls" style="display: none; border-top: 2px solid #f39c12; background: rgba(52,73,94,0.5);">
                <div class="section-title" style="color: #f39c12;">‚öôÔ∏è Edit <span id="selectedWaypointsCount">0</span> Selected Waypoints</div>
                <div class="control-group">
                    <label class="control-label">New Heading Control</label>
                    <select class="control-input" id="multiHeadingControl">
                        <option value="">-- Do Not Change --</option>
                        <option value="auto">Auto (Follow Wayline)</option>
                        <option value="fixed">Fixed Heading (Lock Course)</option>
                        <option value="poi_track">POI Tracking (Toward POI)</option>
                    </select>
                </div>
                <div class="control-group" id="multiTargetPoiForHeadingGroup" style="display: none;">
                    <label class="control-label">Target POI for Heading</label>
                    <select class="control-input" id="multiTargetPoiSelect"> </select>
                </div>
                <div class="control-group" id="multiFixedHeadingGroup" style="display: none;">
                    <label class="control-label">New Fixed Heading (¬∞)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="multiFixedHeading" min="0" max="359" value="0"><span class="slider-value" id="multiFixedHeadingValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">New Camera Action</label>
                    <select class="control-input" id="multiCameraActionSelect">
                        <option value="">-- Do Not Change --</option>
                        <option value="none">No Action</option>
                        <option value="takePhoto">Take Photo</option>
                        <option value="startRecord">Start Recording</option>
                        <option value="stopRecord">Stop Recording</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">New Gimbal Pitch (¬∞)</label>
                     <div class="slider-container">
                        <input type="checkbox" id="multiChangeGimbalPitchCheckbox" style="margin-right: 5px; transform: scale(1.2);"><span class="control-label" style="margin-bottom:0; cursor:pointer;" onclick="document.getElementById('multiChangeGimbalPitchCheckbox').click()">Change</span>
                        <input type="range" class="slider" id="multiGimbalPitch" min="-90" max="0" value="0" disabled><span class="slider-value" id="multiGimbalPitchValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">New Hover Time (s)</label>
                    <div class="slider-container">
                        <input type="checkbox" id="multiChangeHoverTimeCheckbox" style="margin-right: 5px; transform: scale(1.2);"><span class="control-label" style="margin-bottom:0; cursor:pointer;" onclick="document.getElementById('multiChangeHoverTimeCheckbox').click()">Change</span>
                        <input type="range" class="slider" id="multiHoverTime" min="0" max="30" value="0" disabled><span class="slider-value" id="multiHoverTimeValue"></span>
                    </div>
                </div>
                <button class="btn" id="applyMultiEditBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22);">Apply to Selected</button>
                <button class="btn btn-secondary" id="clearMultiSelectionBtn">Cancel Multi-Selection</button>
            </div>

            <div class="section" id="waypointControls" style="display: none;">
                <div class="section-title">‚öôÔ∏è Waypoint Settings</div>
                <div class="control-group">
                    <label class="control-label">Altitude (m) <span style="font-style: italic; color: #95a5a6;">(Rel. to Takeoff)</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="waypointAltitude" min="5" max="120"><span class="slider-value" id="waypointAltitudeValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Hover Time (s)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="hoverTime" min="0" max="30"><span class="slider-value" id="hoverTimeValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Gimbal Pitch (¬∞)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="gimbalPitch" min="-90" max="0" value="0"><span class="slider-value" id="gimbalPitchValue"></span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Heading Control</label>
                    <select class="control-input" id="headingControl">
                        <option value="auto">Auto (Follow Wayline)</option>
                        <option value="fixed">Fixed Heading (Lock Course)</option>
                        <option value="poi_track">POI Tracking (Toward POI)</option>
                    </select>
                </div>
                <div class="control-group" id="targetPoiForHeadingGroup" style="display: none;">
                    <label class="control-label">Target POI for Heading</label>
                    <select class="control-input" id="targetPoiSelect"></select>
                </div>
                <div class="control-group" id="fixedHeadingGroup" style="display: none;">
                    <label class="control-label">Fixed Heading (¬∞)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fixedHeading" min="0" max="359"><span class="slider-value" id="fixedHeadingValue"></span>
                    </div>
                </div>
                <div class="section-title" style="margin-top: 20px; font-size: 14px; border-top: 1px solid #34495e; padding-top: 15px;">üì∏ Camera Actions</div>
                <div class="control-group">
                    <label class="control-label">Camera Action at Waypoint</label>
                    <select class="control-input" id="cameraActionSelect">
                        <option value="none">No Action</option>
                        <option value="takePhoto">Take Photo</option>
                        <option value="startRecord">Start Recording</option>
                        <option value="stopRecord">Stop Recording</option>
                    </select>
                </div>
                <button class="btn btn-danger" id="deleteSelectedWaypointBtn">Delete Waypoint</button>
            </div>

            <div class="section">
                <div class="section-title">üéØ Points of Interest</div>
                <div class="control-group">
                    <input type="text" class="control-input" id="poiName" placeholder="POI Name" maxlength="20">
                </div>
                <div style="font-size: 12px; color: #95a5a6; margin-bottom: 10px;">Ctrl + Click on map to add POI</div>
                <div class="poi-list" id="poiList"></div>
            </div>

            <div class="section">
                <div class="section-title">üèûÔ∏è Terrain & Orbit Tools</div>
                 <div class="control-group">
                    <label class="control-label">Takeoff Point Elevation (MSL, m)</label>
                    <input type="number" class="control-input-small" id="homeElevationMsl" value="0" step="1">
                    <button class="btn-secondary" id="getHomeElevationBtn" style="width:auto; padding: 5px 10px; margin-left:10px; font-size:11px;">Use WP1 Elev.</button>
                </div>
                <div class="control-group">
                    <label class="control-label">Desired Altitude Above Ground (AGL, m)</label>
                    <input type="number" class="control-input-small" id="desiredAGL" value="30" min="5">
                </div>
                <button class="btn" id="adaptToAGLBtn">Adapt Waypoint Altitudes to AGL</button>
                <hr style="border-color: #34495e; margin: 15px 0;">
                <button class="btn" id="createOrbitBtn">Create POI Orbit</button>
            </div>

            <div class="section">
                <div class="section-title">üìÅ File Operations</div>
                <button class="btn btn-secondary" id="importJsonBtn">Import Flight Plan (.json)</button>
                <button class="btn btn-secondary" id="exportJsonBtn">Export Flight Plan (.json)</button>
                <button class="btn btn-secondary" id="exportKmzBtn">Export DJI WPML (.kmz)</button>
                <button class="btn btn-secondary" id="exportGoogleEarthBtn">Export for Google Earth (.kml)</button>
            </div>
            
            <div class="section">
                <div class="section-title">üìä Flight Statistics</div>
                <div class="flight-stats">
                    <div class="stat-row"><span class="stat-label">Total Distance:</span><span class="stat-value" id="totalDistance">0 m</span></div>
                    <div class="stat-row"><span class="stat-label">Est. Flight Time:</span><span class="stat-value" id="flightTime">0 min 0 sec</span></div>
                    <div class="stat-row"><span class="stat-label">Waypoints:</span><span class="stat-value" id="waypointCount">0</span></div>
                    <div class="stat-row"><span class="stat-label">POIs:</span><span class="stat-value" id="poiCount">0</span></div>
                </div>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" id="satelliteToggleBtn">üì° Satellite</button>
                <button class="map-btn" id="fitMapBtn">üéØ Fit View</button>
                <button class="map-btn" id="myLocationBtn">üìç My Location</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" accept=".json" style="display: none;">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="script.js"></script>
</body>
</html>